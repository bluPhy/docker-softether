name: Build

on:
  push:
    branches: master
    paths:
      - "**.dockerfile"
      - "dockerfile"
      - "**.sh"
jobs:
  build:
    runs-on: ubuntu-latest
    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash
    env:
      TAG: "ajleal/softether:latest" # Set the tag to use for the image
      PLATFORMS: "linux/amd64,linux/amd64/v2,linux/arm64,linux/arm/v7" # Set the platforms to build the image for
    steps:
      - name: check out repository
        uses: actions/checkout@v4.1.1
      - name: login to docker hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
      - name: Docker Setup QEMU
        uses: docker/setup-qemu-action@v3.0.0
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3.2.0
        with:
          version: latest
      - name: build image locally and scan with Wiz
        run: |
          docker build . --tag $TAG
      - name: Download Wiz CLI
        run: curl -o wizcli https://wizcli.app.wiz.io/latest/wizcli && chmod +x wizcli
      - name: Authenticate to Wiz and run wiz-cli docker image scan
        run: |
          ./wizcli auth --id "$WIZ_CLIENT_ID" --secret "$WIZ_CLIENT_SECRET"
          ./wizcli docker scan --image $TAG --policy "$POLICY" --driver mountWithLayers
        env:
          POLICY: "Default vulnerabilities policy" # Set the desired Wiz CLI policy to use
          WIZ_CLIENT_ID: ${{ secrets.WIZ_CLIENT_ID }}
          WIZ_CLIENT_SECRET: ${{ secrets.WIZ_CLIENT_SECRET }}
      - name: build image and push to dockerhub
        run: |
          docker buildx build --push --tag $TAG --platform $PLATFORMS .
